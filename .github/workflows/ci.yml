name: ğŸ”„ Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-type-check:
    name: ğŸ” Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ” Run ESLint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint:check
          echo "âœ… ESLint passed"

      - name: ğŸ¨ Check Prettier formatting
        run: |
          echo "ğŸ¨ Checking Prettier formatting..."
          npm run format:check
          echo "âœ… Prettier formatting is correct"

      - name: ğŸ”§ Type check
        run: |
          echo "ğŸ”§ Running TypeScript type check..."
          npm run type-check
          echo "âœ… Type check passed"

  build-test:
    name: ğŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build Next.js application
        env:
          GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          NEXT_PUBLIC_GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ—ï¸ Building Next.js application..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: ğŸ“Š Build size analysis
        run: |
          echo "ğŸ“Š Analyzing build size..."
          du -sh out/ || echo "No out directory found"
          find out -name "*.js" -exec wc -c {} + | sort -n | tail -10 || echo "No JS files found"

      - name: ğŸ§ª Run tests
        run: |
          echo "ğŸ§ª Running tests..."
          npm test
          echo "âœ… Tests completed"

  generate-portfolio:
    name: ğŸ“ Generate Static Portfolio
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸš€ Generate static portfolio
        env:
          GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸš€ Generating static portfolio..."
          npm run generate
          echo "âœ… Portfolio generated successfully"

      - name: ğŸ“ Verify generated files
        run: |
          echo "ğŸ“ Verifying generated files..."
          if [ -d "build" ]; then
            echo "âœ… Build directory exists"
            echo "ğŸ“Š Build directory contents:"
            ls -la build/
            if [ -f "build/index.html" ]; then
              echo "âœ… index.html generated successfully"
              echo "ğŸ“ File size: $(wc -c < build/index.html) bytes"
            else
              echo "âŒ index.html not found"
              exit 1
            fi
          else
            echo "âŒ Build directory not found"
            exit 1
          fi

      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ Deploy portfolio - ${{ github.sha }}'

      - name: ğŸ“Š Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "âœ… Workflow completed"
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸŒ GitHub Pages URL: https://${{ github.repository_owner }}.github.io/Portifolio"
