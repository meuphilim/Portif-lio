name: ğŸ”„ IntegraÃ§Ã£o ContÃ­nua

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-e-verificacao-tipos:
    name: ğŸ” Lint e VerificaÃ§Ã£o de Tipos
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Fazer checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch_depth: 0

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… DependÃªncias instaladas com sucesso"

      - name: ğŸ” Executar ESLint
        run: |
          echo "ğŸ” Executando ESLint..."
          npm run lint:check
          echo "âœ… ESLint passou"

      - name: ğŸ¨ Verificar formataÃ§Ã£o Prettier
        run: |
          echo "ğŸ¨ Verificando formataÃ§Ã£o Prettier..."
          npm run format:check
          echo "âœ… FormataÃ§Ã£o Prettier estÃ¡ correta"

      - name: ğŸ”§ VerificaÃ§Ã£o de tipos
        run: |
          echo "ğŸ”§ Executando verificaÃ§Ã£o de tipos TypeScript..."
          npm run type-check
          echo "âœ… VerificaÃ§Ã£o de tipos passou"

  build-e-teste:
    name: ğŸ—ï¸ Build e Teste
    runs-on: ubuntu-latest
    needs: lint-e-verificacao-tipos
    
    steps:
      - name: ğŸ“¥ Fazer checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o Next.js
        env:
          GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          NEXT_PUBLIC_GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ—ï¸ Fazendo build da aplicaÃ§Ã£o Next.js..."
          npm run build
          echo "âœ… Build concluÃ­do com sucesso"

      - name: ğŸ“Š AnÃ¡lise do tamanho do build
        run: |
          echo "ğŸ“Š Analisando tamanho do build..."
          du -sh out/ || echo "DiretÃ³rio out nÃ£o encontrado"
          find out -name "*.js" -exec wc -c {} + | sort -n | tail -10 || echo "Nenhum arquivo JS encontrado"

      - name: ğŸ§ª Executar testes
        run: |
          echo "ğŸ§ª Executando testes..."
          npm test
          echo "âœ… Testes concluÃ­dos"

  gerar-portfolio:
    name: ğŸ“ Gerar PortfÃ³lio EstÃ¡tico
    runs-on: ubuntu-latest
    needs: build-e-teste
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Fazer checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci --prefer-offline --no-audit

      - name: ğŸš€ Gerar portfÃ³lio estÃ¡tico
        env:
          GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸš€ Gerando portfÃ³lio estÃ¡tico..."
          npm run gerar
          echo "âœ… PortfÃ³lio gerado com sucesso"

      - name: ğŸ“ Verificar arquivos gerados
        run: |
          echo "ğŸ“ Verificando arquivos gerados..."
          if [ -d "build" ]; then
            echo "âœ… DiretÃ³rio build existe"
            echo "ğŸ“Š ConteÃºdo do diretÃ³rio build:"
            ls -la build/
            if [ -f "build/index.html" ]; then
              echo "âœ… index.html gerado com sucesso"
              echo "ğŸ“ Tamanho do arquivo: $(wc -c < build/index.html) bytes"
            else
              echo "âŒ index.html nÃ£o encontrado"
              exit 1
            fi
          else
            echo "âŒ DiretÃ³rio build nÃ£o encontrado"
            exit 1
          fi

      - name: ğŸŒ Deploy para GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ Deploy do portfÃ³lio - ${{ github.sha }}'

      - name: ğŸ“Š Resumo do deployment
        if: always()
        run: |
          echo "ğŸ“Š Resumo do Deployment"
          echo "======================"
          echo "âœ… Workflow concluÃ­do"
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸŒ URL do GitHub Pages: https://${{ github.repository_owner }}.github.io/Portifolio"
