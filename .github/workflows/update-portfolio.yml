name: Atualizar PortfÃ³lio

on:
  schedule:
    # Executa a cada 12 horas (00:00 e 12:00 UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    # Permite execuÃ§Ã£o manual
  push:
    branches: [ main ]
    paths:
      - 'update_catalog.js'
      - 'package.json'
      - '.github/workflows/update-portfolio.yml'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # Remover cache atÃ© termos um lock file
        # cache: 'npm'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        echo "ğŸ“¦ Instalando dependÃªncias..."
        npm install
        echo "âœ… DependÃªncias instaladas com sucesso"

    - name: ğŸ” Verificar ambiente
      run: |
        echo "ğŸ” Verificando ambiente..."
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "Working directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        echo "Environment variables:"
        echo "GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}"
        echo "GITHUB_TOKEN configured: ${{ secrets.GITHUB_TOKEN != '' }}"

    - name: ğŸš€ Gerar portfÃ³lio estÃ¡tico
      env:
        GITHUB_USERNAME: ${{ vars.GITHUB_USERNAME || 'meuphilim' }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTIONS: true
      run: |
        echo "ğŸš€ Iniciando geraÃ§Ã£o do portfÃ³lio..."
        node update_catalog.js
        echo "âœ… PortfÃ³lio gerado com sucesso"

    - name: ğŸ“ Verificar arquivos gerados
      run: |
        echo "ğŸ“ Verificando arquivos gerados..."
        if [ -d "build" ]; then
          echo "âœ… DiretÃ³rio build encontrado"
          echo "ConteÃºdo do build:"
          ls -la build/
          if [ -f "build/index.html" ]; then
            echo "âœ… index.html gerado com sucesso"
            echo "Tamanho do arquivo: $(wc -c < build/index.html) bytes"
          else
            echo "âŒ index.html nÃ£o encontrado"
            exit 1
          fi
        else
          echo "âŒ DiretÃ³rio build nÃ£o encontrado"
          exit 1
        fi

    - name: ğŸ”§ Configurar Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ğŸ“¤ Commit e push das alteraÃ§Ãµes
      run: |
        echo "ğŸ“¤ Verificando se hÃ¡ alteraÃ§Ãµes para commit..."
        git add build/ || true
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o detectada no portfÃ³lio"
        else
          echo "ğŸ“ AlteraÃ§Ãµes detectadas, fazendo commit..."
          git commit -m "ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica do portfÃ³lio - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… AlteraÃ§Ãµes enviadas com sucesso"
        fi

    - name: ğŸŒ Deploy para GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ğŸš€ Deploy automÃ¡tico do portfÃ³lio - ${{ github.sha }}'

    - name: ğŸ”§ Deploy para Vercel
      if: github.ref == 'refs/heads/main'
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        echo "ğŸ”§ Iniciando deploy para Vercel..."
        
        # Verificar se as variÃ¡veis estÃ£o configuradas
        if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
          echo "âš ï¸ VariÃ¡veis do Vercel nÃ£o configuradas, pulando deploy"
          exit 0
        fi
        
        # Instalar Vercel CLI
        npm install -g vercel@latest
        
        # Fazer deploy
        echo "ğŸš€ Fazendo deploy para Vercel..."
        vercel deploy --prod --token="$VERCEL_TOKEN" --yes
        echo "âœ… Deploy para Vercel concluÃ­do"

    - name: ğŸ“Š RelatÃ³rio final
      if: always()
      run: |
        echo "ğŸ“Š RelatÃ³rio Final da ExecuÃ§Ã£o"
        echo "================================"
        echo "âœ… Workflow executado com sucesso"
        echo "ğŸ“… Data/Hora: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref }}"
        
        if [ -f "build/index.html" ]; then
          echo "ğŸ“„ PortfÃ³lio gerado: âœ…"
          echo "ğŸ“ Tamanho: $(wc -c < build/index.html) bytes"
        else
          echo "ğŸ“„ PortfÃ³lio gerado: âŒ"
        fi
        
        echo "ğŸŒ URLs de acesso:"
        echo "   GitHub Pages: https://${{ github.repository_owner }}.github.io/Portifolio"
        echo "   Vercel: https://portfolio-github.vercel.app"
